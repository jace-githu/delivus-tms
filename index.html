<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>딜리래빗 TMS v3.1.1</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;background:#f5f5f7;color:#1d1d1f;overflow:hidden;height:100vh}
    .app-container{display:grid;grid-template-areas:"sidebar map map" "sidebar map map" "bottom bottom bottom";grid-template-columns:380px 1fr 1fr;grid-template-rows:1fr 1fr auto;height:100vh;gap:1px;background:#e5e5e5}
    .sidebar{grid-area:sidebar;background:#fff;display:flex;flex-direction:column;overflow:hidden;box-shadow:2px 0 8px rgba(0,0,0,.05)}
    .brand-header{padding:16px;border-bottom:1px solid #e5e5e5;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(to right,#f8f9fa,#fff)}
    .brand-logo{display:flex;align-items:center;gap:10px}
    .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,#6e6eff 0%,#5555dd 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
    .logo-text{font-size:16px;font-weight:700;color:#1d1d1f}
    .notification-btn{position:relative;width:36px;height:36px;border:1px solid #d1d1d6;border-radius:8px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:.2s}
    .notification-btn:hover{background:#f5f5f7;border-color:#6e6eff}
    .notification-badge{position:absolute;top:-4px;right:-4px;background:#ff3b30;color:#fff;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:600}
    .dashboard-section{padding:16px;background:#f8f9fa;border-bottom:1px solid #e5e5e5}
    .dashboard-title{font-size:13px;font-weight:600;color:#86868b;margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .stat-card{background:#fff;border:1px solid #e5e5e5;border-radius:8px;padding:14px;transition:.2s}
    .stat-card:hover{border-color:#6e6eff;box-shadow:0 2px 8px rgba(110,110,255,.1);transform:translateY(-1px)}
    .stat-label{font-size:11px;color:#86868b;margin-bottom:4px}
    .stat-value{font-size:24px;font-weight:700;margin-bottom:2px}
    .stat-value.primary{color:#6e6eff}.stat-value.success{color:#34c759}.stat-value.warning{color:#ff9500}.stat-value.danger{color:#ff3b30}
    .stat-change{font-size:10px;color:#86868b}
    .tabs-container{flex:1;display:flex;flex-direction:column;overflow:hidden}
    .tabs-nav{display:flex;background:#fff;border-bottom:1px solid #e5e5e5;padding:0 12px}
    .tab{padding:12px 16px;border:none;background:none;cursor:pointer;font-size:13px;font-weight:500;color:#666;border-bottom:2px solid transparent;transition:.2s;white-space:nowrap}
    .tab:hover{color:#6e6eff;background:#f5f5f7}
    .tab.active{color:#6e6eff;border-bottom-color:#6e6eff;font-weight:600}
    .tab-content-area{flex:1;overflow-y:auto;padding:16px;background:#fff}
    .tab-pane{display:none}.tab-pane.active{display:block}
    .refresh-section{padding:12px 16px;border-top:1px solid #e5e5e5;background:#fff}
    .btn-refresh{width:100%;padding:10px;border:1px solid #6e6eff;border-radius:8px;background:#fff;color:#6e6eff;font-size:14px;font-weight:500;cursor:pointer;transition:.2s}
    .btn-refresh:hover{background:#6e6eff;color:#fff}
    .map-container{grid-area:map;position:relative;background:#f5f5f7}
    #map{width:100%;height:100%}
    .map-controls{position:absolute;top:16px;right:16px;z-index:1000;display:flex;flex-direction:column;gap:8px}
    .map-btn{width:44px;height:44px;background:#fff;border:1px solid #d1d1d6;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.1);transition:.2s;font-size:20px;display:flex;align-items:center;justify-content:center}
    .map-btn:hover{background:#6e6eff;color:#fff;border-color:#6e6eff}
    .bottom-panel{grid-area:bottom;background:#fff;border-top:2px solid #e5e5e5;height:50px;transition:height .3s ease;overflow:hidden}
    .bottom-panel.open{height:350px}
    .panel-header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:#fafafa;cursor:pointer;user-select:none}
    .panel-header:hover{background:#f5f5f7}
    .panel-header-left{display:flex;align-items:center;gap:12px}
    .toggle-btn{width:24px;height:24px;border:1px solid #d1d1d6;border-radius:4px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;transition:.2s}
    .panel-title{font-size:14px;font-weight:600;color:#1d1d1f}
    /* 전체 기사 수 칩 */
    .count-chip{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid #e5e5e5;border-radius:999px;padding:6px 10px;font-size:12px;color:#666}
    .count-chip strong{color:#1d1d1f}
    .panel-header-right{display:flex;align-items:center;gap:12px}
    .filter-bar{display:flex;align-items:center;gap:8px}
    .search-input{width:200px;padding:8px 12px;border:1px solid #d1d1d6;border-radius:6px;font-size:13px;outline:none}
    .search-input:focus{border-color:#6e6eff;box-shadow:0 0 0 3px rgba(110,110,255,.1)}
    .filter-select{padding:8px 12px;border:1px solid #d1d1d6;border-radius:6px;font-size:13px;cursor:pointer}
    .btn-sm{padding:8px 14px;border:1px solid #d1d1d6;border-radius:6px;background:#fff;font-size:13px;cursor:pointer;transition:.2s}
    .btn-sm:hover{background:#6e6eff;color:#fff;border-color:#6e6eff}
    .table-container{overflow:auto;height:280px;padding:0 20px 20px}
    .driver-table{width:100%;border-collapse:collapse;font-size:13px}
    .driver-table th{position:sticky;top:0;background:#fff;padding:12px 8px;text-align:left;font-size:11px;font-weight:600;color:#86868b;border-bottom:2px solid #e5e5e5;cursor:pointer;z-index:10}
    .driver-table th:hover{color:#6e6eff}
    .driver-table td{padding:10px 8px;border-bottom:1px solid #f5f5f7}
    .driver-table tbody tr{cursor:pointer;transition:background .2s}
    .driver-table tbody tr:hover{background:#f5f5f7}
    .driver-table tbody tr.filtered-out{display:none}
    .driver-name-clickable{color:#6e6eff;font-weight:600;cursor:pointer}
    .driver-name-clickable:hover{text-decoration:underline}
    .status-badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;display:inline-block}
    .status-pickup{background:#d1f4e0;color:#0f5132}
    .status-not-pickup{background:#fff3cd;color:#856404}
    .status-delayed{background:#ffe5e5;color:#c41e3a}
    .status-normal{background:#d1f4e0;color:#0f5132}
    .toast{position:fixed;bottom:24px;right:24px;background:#fff;border:1px solid #e5e5e5;border-radius:8px;padding:16px 20px;box-shadow:0 4px 12px rgba(0,0,0,.15);display:none;z-index:10001;min-width:300px}
    .toast.active{display:block;animation:slideIn .3s ease}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast.success{border-left:4px solid #34c759}.toast.error{border-left:4px solid #ff3b30}.toast.warning{border-left:4px solid #ff9500}.toast.info{border-left:4px solid #6e6eff}
    .toast-content{display:flex;flex-direction:column}
    .toast-title{font-weight:600;font-size:14px;margin-bottom:2px}
    .toast-message{font-size:13px;color:#666}
    .driver-card{background:#fff;border:1px solid #e5e5e5;border-radius:6px;padding:12px;margin-bottom:8px;cursor:pointer;transition:.2s}
    .driver-card:hover{border-color:#6e6eff;box-shadow:0 2px 8px rgba(110,110,255,.1)}
    .driver-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .driver-name{font-weight:600;font-size:14px;color:#1d1d1f}
    .driver-info{font-size:12px;color:#666;margin-bottom:4px}
    .region-item{background:#fff;border:1px solid #e5e5e5;border-radius:6px;padding:12px;margin-bottom:8px;cursor:pointer;transition:.2s}
    .region-item:hover{border-color:#6e6eff;transform:translateY(-1px)}
    .region-name{font-weight:600;font-size:14px;color:#6e6eff;margin-bottom:8px}
    .region-stats{display:flex;justify-content:space-between;font-size:12px;color:#666}
    ::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:#f5f5f7}::-webkit-scrollbar-thumb{background:#d1d1d6;border-radius:3px}::-webkit-scrollbar-thumb:hover{background:#86868b}
    .guide-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);z-index:10000;display:none}
    .guide-overlay.active{display:block}
    .guide-tooltip{position:fixed;background:linear-gradient(135deg,#6e6eff 0%,#5555dd 100%);color:#fff;padding:20px;border-radius:12px;max-width:350px;z-index:10001;box-shadow:0 8px 32px rgba(110,110,255,.4);opacity:0;transform:scale(.9);transition:.2s}
    .guide-tooltip.active{opacity:1;transform:scale(1)}
    .guide-tooltip-header{font-size:18px;font-weight:700;margin-bottom:12px}
    .guide-tooltip-content{font-size:14px;line-height:1.6;margin-bottom:16px;white-space:pre-line}
    .guide-buttons{display:flex;gap:8px;justify-content:space-between}
    .guide-btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:.2s}
    .guide-btn-skip{background:rgba(255,255,255,.2);color:#fff}.guide-btn-next{background:#fff;color:#6e6eff}.guide-btn-finish{background:#34c759;color:#fff}
    .guide-highlight{position:fixed;border:3px solid #6e6eff;border-radius:8px;pointer-events:none;z-index:9999;box-shadow:0 0 0 4px rgba(110,110,255,.3);display:none}
    .guide-highlight.active{display:block}
    @media (max-width:1200px){.app-container{grid-template-columns:280px 1fr 1fr}}
    @media (max-width:768px){
      .app-container{grid-template-areas:"sidebar" "map" "bottom";grid-template-columns:1fr;grid-template-rows:auto 400px auto}
      .sidebar{height:auto;max-height:50vh;overflow-y:auto}
    }
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="brand-header">
        <div class="brand-logo">
          <div class="logo-icon">D</div>
          <span class="logo-text">딜리래빗 TMS</span>
        </div>
        <button class="notification-btn" onclick="showNotifications()">🔔
          <span class="notification-badge" id="notificationCount">0</span>
        </button>
      </div>

      <div class="dashboard-section">
        <h3 class="dashboard-title">실시간 대시보드</h3>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label">총 배송</div><div class="stat-value primary" id="totalOrders">0</div><div class="stat-change">전체 배송량</div></div>
          <div class="stat-card"><div class="stat-label">완료</div><div class="stat-value success" id="completedDeliveries">0</div><div class="stat-change">배송 완료</div></div>
          <div class="stat-card"><div class="stat-label">진행중</div><div class="stat-value warning" id="inProgress">0</div><div class="stat-change">배송 진행</div></div>
          <div class="stat-card"><div class="stat-label">지연</div><div class="stat-value danger" id="delayedCount">0</div><div class="stat-change">20분 이상</div></div>
          <div class="stat-card"><div class="stat-label">완료율</div><div class="stat-value success" id="overallCompletionRate">0%</div><div class="stat-change">전체 완료율</div></div>
          <div class="stat-card"><div class="stat-label">실패 건수</div><div class="stat-value danger" id="failedDeliveries">0</div><div class="stat-change">처리 필요</div></div>
        </div>
      </div>

      <div class="tabs-container">
        <nav class="tabs-nav">
          <button class="tab active" onclick="switchTab(event,'monitor')">실시간관제</button>
          <button class="tab" onclick="switchTab(event,'drivers')">기사관리</button>
          <button class="tab" onclick="switchTab(event,'regions')">지역현황</button>
          <button class="tab" onclick="switchTab(event,'stats')">통계분석</button>
        </nav>

        <div class="tab-content-area">
          <div id="tab-monitor" class="tab-pane active"><h4 style="font-size:14px;font-weight:600;margin-bottom:12px;">⚠️ 관제 필요</h4><div id="alertList"></div></div>
          <div id="tab-drivers" class="tab-pane"><div id="driversList"></div></div>
          <div id="tab-regions" class="tab-pane"><div id="regionsList"></div></div>
          <div id="tab-stats" class="tab-pane"><h4 style="font-size:14px;font-weight:600;margin-bottom:12px;">운송사별 성과</h4><div id="companyStats"></div></div>
        </div>
      </div>

      <div class="refresh-section">
        <button class="btn-refresh" onclick="loadGitHubData()">🔄 데이터 새로고침</button>
      </div>
    </aside>

    <main class="map-container">
      <div id="map"></div>
      <div class="map-controls">
        <button class="map-btn" onclick="resetMapView()" title="전체보기">🌍</button>
        <button class="map-btn" onclick="showGuide()" title="가이드">📖</button>
      </div>
    </main>

    <section class="bottom-panel" id="bottomPanel">
      <div class="panel-header" onclick="toggleBottomPanel()">
        <div class="panel-header-left">
          <button class="toggle-btn" id="toggleBtn" onclick="event.stopPropagation();toggleBottomPanel()">▲</button>
          <h3 class="panel-title">상세 현황</h3>
          <!-- 전체 기사 수 칩 -->
          <div class="count-chip" onclick="event.stopPropagation()">
            전체 기사 수 <strong id="totalCountChip">0명</strong>
          </div>
        </div>
        <div class="panel-header-right">
          <div class="filter-bar" onclick="event.stopPropagation()">
            <input type="text" class="search-input" placeholder="기사명, 전화번호 검색" id="driverSearch">
            <select class="filter-select" id="controlFilter" onchange="applyFilters()">
              <option value="">전체 관제</option><option value="지연">지연</option><option value="미픽업">미픽업</option>
            </select>
            <select class="filter-select" id="companyFilter" onchange="applyFilters()"><option value="">전체 운송사</option></select>
            <select class="filter-select" id="regionFilter" onchange="applyFilters()"><option value="">전체 지역</option></select>
            <button class="btn-sm" onclick="event.stopPropagation();resetFilters()">↻ 초기화</button>
          </div>
          <!-- 버튼들: 패널 토글 방지 -->
          <button class="btn-sm" onclick="event.stopPropagation();copyPhoneNumbers()">📞 번호복사</button>
          <button class="btn-sm" onclick="event.stopPropagation();openAppPush()">📱 App Push</button>
          <button class="btn-sm" onclick="event.stopPropagation();exportData()">📥 내보내기</button>
          <span style="margin-left:12px;font-size:13px;color:#666;"><strong id="visibleCount">0</strong> / <span id="totalCount">0</span></span>
        </div>
      </div>

      <div class="table-container">
        <table class="driver-table">
          <thead>
            <tr>
              <th onclick="sortTable('name')">기사명 <span class="sort-icon">↕</span></th>
              <th onclick="sortTable('deliveryBox')">배송박스 <span class="sort-icon">↕</span></th>
              <th onclick="sortTable('company')">운송사 <span class="sort-icon">↕</span></th>
              <th onclick="sortTable('phone')">전화번호 <span class="sort-icon">↕</span></th>
              <th onclick="sortTable('totalDeliveries')">총건수 <span class="sort-icon">↕</span></th>
              <th onclick="sortTable('completedDeliveries')">완료 <span class="sort-icon">↕</span></th>
              <th onclick="sortTable('failedDeliveries')">실패 <span class="sort-icon">↕</span></th>
              <th onclick="sortTable('completionRate')">완료율 <span class="sort-icon">↕</span></th>
              <th onclick="sortTable('pickupStatus')">픽업여부 <span class="sort-icon">↕</span></th>
              <th onclick="sortTable('delayStatus')">지연(20분) <span class="sort-icon">↕</span></th>
              <th onclick="sortTable('region')">지역 <span class="sort-icon">↕</span></th>
            </tr>
          </thead>
          <tbody id="driverTableBody">
            <tr><td colspan="11" style="text-align:center;padding:2rem;">데이터를 로딩 중입니다...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="toast" class="toast">
    <div class="toast-content">
      <div class="toast-title" id="toastTitle">알림</div>
      <div class="toast-message" id="toastMessage">메시지</div>
    </div>
  </div>

  <div class="guide-overlay" id="guideOverlay"></div>
  <div class="guide-tooltip" id="guideTooltip">
    <div class="guide-tooltip-header" id="guideTitle">가이드</div>
    <div class="guide-tooltip-content" id="guideContent">내용</div>
    <div class="guide-buttons">
      <button class="guide-btn guide-btn-skip" onclick="endGuide()">건너뛰기</button>
      <button class="guide-btn guide-btn-next" id="guideNext" onclick="nextGuide()">다음</button>
    </div>
  </div>
  <div class="guide-highlight" id="guideHighlight"></div>

  <script>
    // ========= 전역 =========
    let map, markerCluster;
    let driverMarkers = new Map();
    let tmsData = null;
    let allDrivers = [];
    let sortOrder = {};
    let bottomPanelOpen = false;
    let autoRefreshInterval = null;
    let currentGuideStep = 0;
    let isGuideActive = false;
    let wasPanelOpenBeforeGuide = null;   // [NEW] 가이드 시작 전 상태 저장

    // 검색 인덱스 & DOM 캐시
    let searchIndex = [];
    let rowById = new Map();
    let lastFilteredIds = null;

    const GITHUB_CONFIG = { owner:'jace-githu', repo:'delivus-tms', path:'data/tms_data.json', branch:'main' };

    // === 기능 위주 가이드 (슬림화) ===
    const guideSteps = [
      { element: '.dashboard-section', title: '📊 대시보드', content: '총 배송/완료/지연 등 핵심 지표를 즉시 확인합니다.' },
      { element: '.tabs-nav',         title: '📑 탭 전환', content: '실시간관제/기사관리/지역현황/통계분석으로 필요한 정보를 빠르게 찾습니다.' },
      { element: '#map',              title: '🗺️ 지도 관제', content: '마커 색상 의미\n• 회색 100% 완료\n• 초록 정상\n• 주황 미픽업\n• 빨강 지연' },
      { element: '.map-controls',     title: '🎛️ 지도 컨트롤', content: '🌍 전체보기, 📖 가이드 호출이 가능합니다.' },
      { element: '.panel-header',     title: '▼ 상세 현황 열기', content: '클릭하여 하단 상세 테이블을 펼칩니다.', openBottomPanel: true },
      { element: '#driverSearch',     title: '🔍 통합 검색', content: '기사명/전화번호 검색 시 테이블과 지도가 함께 필터링됩니다.', openBottomPanel: true },
      { element: '.filter-bar',       title: '🎯 필터', content: '관제 상태/운송사/지역별로 좁혀보기. ↻ 초기화로 원복.', openBottomPanel: true },
      { element: '.driver-table',     title: '📋 정렬·포커스', content: '헤더 클릭 정렬, 기사명 클릭 시 지도에서 위치 포커스.', openBottomPanel: true },
      { element: '.panel-header-right',title:'⚡ 빠른 액션', content:'📞번호복사 / 📱App Push / 📥CSV 내보내기', openBottomPanel: true }
    ];

    // ========= 유틸 =========
    const debounce = (fn, delay=200) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),delay); }; };
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const toDigits = s => (s||'').replace(/[^0-9]/g,'');

    // ========= 초기화 =========
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      bindSearchInput();
      loadGitHubData();
      startAutoRefresh();
      setupSearchFocus();
    });

    // ========= 지도 =========
    function initMap(){
      map = L.map('map',{preferCanvas:true,zoomControl:true,attributionControl:false})
              .setView([37.5665,126.9780],11);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'© OpenStreetMap', maxZoom:18, minZoom:8, updateWhenIdle:false, updateWhenZooming:false
      }).addTo(map);

      markerCluster = L.markerClusterGroup({
        maxClusterRadius:50, disableClusteringAtZoom:14, spiderfyOnMaxZoom:true,
        showCoverageOnHover:false, zoomToBoundsOnClick:true,
        chunkedLoading:true, chunkInterval:200, chunkDelay:50,
        iconCreateFunction(cluster){
          const n = cluster.getChildCount();
          const size = n<10?30:n<25?35:40;
          return new L.DivIcon({
            html:`<div style="background:linear-gradient(135deg,#6e6eff 0%,#5555dd 100%);width:${size}px;height:${size}px;border-radius:50%;border:2px solid #fff;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:${size<35?12:14}px;box-shadow:0 2px 8px rgba(110,110,255,.4);">${n}</div>`,
            className:'marker-cluster', iconSize:new L.Point(size,size)
          });
        }
      });
      map.addLayer(markerCluster);
    }

    function resetMapView(){
      map.setView([37.5665,126.9780],11);
      resetFilters();
      showToast('success','전체 지도','전체 보기로 돌아갔습니다.');
    }

    // ========= 데이터 로드 =========
    async function loadGitHubData(){
      try{
        const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}?t=${Date.now()}`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const rawText = await res.text();
        tmsData = JSON.parse(rawText);
        allDrivers = tmsData.drivers||[];

        buildSearchIndex();
        updateDashboard();
        updateTabs();
        renderDriverTable();
        updateFilterOptions();
        showDriversOnMap(allDrivers,true);

        showToast('success','데이터 로드 완료',`${allDrivers.length}명의 기사 정보를 불러왔습니다.`);
      }catch(e){
        console.error(e);
        showToast('error','데이터 로드 실패',e.message);
      }
    }

    // ========= 인덱싱 / 테이블 =========
    function buildSearchIndex(){
      searchIndex = allDrivers.map(d=>({
        id:d.id,
        nameL:(d.name||'').toLowerCase(),
        nameNS:(d.name||'').replace(/\s+/g,'').toLowerCase(),
        phoneD:toDigits(d.phone)
      }));
    }

    function renderDriverTable(){
      const tbody = document.getElementById('driverTableBody');
      rowById.clear();
      const frag = document.createDocumentFragment();
      allDrivers.forEach(d=>{
        const tr = document.createElement('tr');
        tr.setAttribute('data-driver-id', d.id);
        tr.innerHTML = `
          <td><strong class="driver-name-clickable" onclick="focusOnDriver('${d.id}')">${d.name||''}</strong></td>
          <td>${d.deliveryBox||'-'}</td>
          <td>${d.company||'-'}</td>
          <td>${d.phone||'-'}</td>
          <td style="color:#6e6eff;font-weight:600;">${d.totalDeliveries||0}</td>
          <td style="color:#34c759;font-weight:600;">${d.completedDeliveries||0}</td>
          <td style="color:#ff3b30;font-weight:600;">${d.failedDeliveries||0}</td>
          <td><strong>${d.completionRate||0}%</strong></td>
          <td><span class="status-badge ${d.pickupStatus==='픽업'?'status-pickup':'status-not-pickup'}">${d.pickupStatus||'미픽업'}</span></td>
          <td><span class="status-badge ${d.delayStatus==='지연'?'status-delayed':'status-normal'}">${d.delayStatus||'정상'}</span></td>
          <td>${d.region||'-'}</td>
        `;
        frag.appendChild(tr);
        rowById.set(d.id, tr);
      });
      tbody.innerHTML = '';
      tbody.appendChild(frag);

      // 총/가시 수 갱신 + 칩 업데이트
      document.getElementById('totalCount').textContent = allDrivers.length;
      document.getElementById('visibleCount').textContent = allDrivers.length;
      document.getElementById('totalCountChip').textContent = `${allDrivers.length}명`;

      lastFilteredIds = new Set(allDrivers.map(d=>d.id));
    }

    // ========= 대시보드/탭/필터 =========
    function updateDashboard(){
      if(!tmsData||!tmsData.stats) return;
      const s=tmsData.stats;
      totalOrders.textContent=s.totalOrders||0;
      completedDeliveries.textContent=s.completedDeliveries||0;
      inProgress.textContent=s.inProgress||0;
      delayedCount.textContent=s.delayedCount||0;
      overallCompletionRate.textContent=(s.overallCompletionRate||0)+'%';
      failedDeliveries.textContent=s.failedDeliveries||0;
      notificationCount.textContent=(s.delayedCount||0)+(s.notPickupCount||0);
    }

    function updateTabs(){
      const alertDrivers = allDrivers.filter(d=>d.delayStatus==='지연'||d.pickupStatus==='미픽업').slice(0,10);
      alertList.innerHTML = alertDrivers.length
        ? alertDrivers.map(d=>`
            <div class="alert-card ${d.delayStatus==='지연'?'danger':''}" onclick="focusOnDriver('${d.id}')">
              <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                <strong>${d.name}</strong><span>${d.delayStatus==='지연'?'🔴 지연':'🟡 미픽업'}</span>
              </div>
              <div style="font-size:11px;color:#666;">${d.company} | ${d.region} | 완료율 ${d.completionRate}%</div>
            </div>`).join('')
        : '<div style="text-align:center;padding:20px;color:#86868b;">관제가 필요한 기사가 없습니다 ✓</div>';

      const driverHtml = allDrivers.slice(0,15).map(d=>`
        <div class="driver-card" onclick="focusOnDriver('${d.id}')">
          <div class="driver-card-header">
            <span class="driver-name">${d.name}</span>
            <span class="status-badge ${d.delayStatus==='지연'?'status-delayed':(d.pickupStatus==='픽업'?'status-pickup':'status-not-pickup')}">
              ${d.delayStatus==='지연'?'지연':d.pickupStatus}
            </span>
          </div>
          <div class="driver-info">📦 ${d.completedDeliveries}/${d.totalDeliveries} (${d.completionRate}%)</div>
          <div class="driver-info">${d.company} | ${d.region}</div>
        </div>`).join('');
      driversList.innerHTML = driverHtml;

      if(tmsData.regions){
        regionsList.innerHTML = tmsData.regions.map(r=>`
          <div class="region-item" onclick="focusOnRegion('${r.name}')">
            <div class="region-name">${r.name}</div>
            <div class="region-stats"><span>완료: ${r.delivered||0}</span><span>진행: ${r.transit||0}</span><span>완료율: ${r.completionRate||0}%</span></div>
          </div>`).join('');
      }
    }

    function updateFilterOptions(){
      const companies=[...new Set(allDrivers.map(d=>d.company).filter(Boolean))].sort();
      const regions=[...new Set(allDrivers.map(d=>d.region).filter(Boolean))].sort();
      companyFilter.innerHTML = '<option value="">전체 운송사</option>'+companies.map(c=>`<option value="${c}">${c}</option>`).join('');
      regionFilter.innerHTML = '<option value="">전체 지역</option>'+regions.map(r=>`<option value="${r}">${r}</option>`).join('');
    }

    // ========= 지도 마커 =========
    function showDriversOnMap(drivers, force=false){
      if(!map||!drivers) return;
      const newIds = new Set(drivers.map(d=>d.id));
      const same = lastFilteredIds && newIds.size===lastFilteredIds.size && [...newIds].every(id=>lastFilteredIds.has(id));
      if(!force && same) return;

      markerCluster.clearLayers();
      driverMarkers.clear();

      const markers = [];
      for(const d of drivers){
        if(!d.coordinates || d.coordinates.length!==2) continue;
        const isCompleted = Number(d.completionRate||0)===100;
        const color = isCompleted ? '#9ca3af' : (d.delayStatus==='지연'?'#ff3b30':(d.pickupStatus==='미픽업'?'#ff9500':'#34c759'));
        const icon = L.divIcon({
          className:'driver-marker',
          html:`<div style="background:${color};width:16px;height:16px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.3);"></div>`,
          iconSize:[20,20], iconAnchor:[10,10]
        });
        const mk = L.marker(d.coordinates,{icon}).bindPopup(
          `<div style="font-size:12px;"><strong style="color:#6e6eff;">${d.name}</strong><br>📦 ${d.deliveryBox||'-'}<br>📱 ${d.phone||''}<br>완료: ${d.completedDeliveries}/${d.totalDeliveries} (${d.completionRate}%)</div>`,
          {maxWidth:200}
        );
        markers.push(mk);
        driverMarkers.set(d.id, mk);
      }
      if(markers.length) markerCluster.addLayers(markers);
      lastFilteredIds = newIds;
    }

    // ========= 검색/필터 =========
    function bindSearchInput(){
      const handler = debounce(()=>{
        const term = driverSearch.value.trim().toLowerCase();
        if(!term){
          for(const [id,row] of rowById.entries()) row.classList.remove('filtered-out');
          visibleCount.textContent = allDrivers.length;
          document.getElementById('totalCountChip').textContent = `${allDrivers.length}명`;
          showDriversOnMap(allDrivers);
          return;
        }
        const termNS = term.replace(/\s+/g,'');
        const termD  = toDigits(term);

        let visible = 0;
        const matchedIds = [];
        for(const ix of searchIndex){
          const nameMatch = ix.nameL.includes(term) || ix.nameNS.includes(termNS) || [...term].every(c=>ix.nameL.includes(c));
          const phoneMatch = termD && ix.phoneD.includes(termD);
          const ok = nameMatch || phoneMatch;
          const row = rowById.get(ix.id);
          if(!row) continue;
          if(ok){ row.classList.remove('filtered-out'); visible++; matchedIds.push(ix.id); }
          else  { row.classList.add('filtered-out'); }
        }
        visibleCount.textContent = visible;
        showDriversOnMap(allDrivers.filter(d=>matchedIds.includes(d.id)));
      },200);
      driverSearch.addEventListener('input', handler);
    }

    function applyFilters(){
      const cF = controlFilter.value, compF = companyFilter.value, rF = regionFilter.value;
      const filtered = allDrivers.filter(d=>{
        const a = !compF || d.company===compF;
        const b = !rF || d.region===rF;
        let c = true;
        if(cF==='지연') c = d.delayStatus==='지연' && Number(d.completionRate||0)<100;
        else if(cF==='미픽업') c = d.pickupStatus==='미픽업';
        return a && b && c;
      });

      for(const [id,row] of rowById.entries()){
        row.classList.toggle('filtered-out', !filtered.some(d=>d.id===id));
      }
      visibleCount.textContent = filtered.length;
      // 총 칩은 전체 수를 표현(요청사항), 유지
      document.getElementById('totalCountChip').textContent = `${allDrivers.length}명`;
      showDriversOnMap(filtered);
    }

    function resetFilters(){
      controlFilter.value=''; companyFilter.value=''; regionFilter.value=''; driverSearch.value='';
      for(const [_,row] of rowById.entries()) row.classList.remove('filtered-out');
      visibleCount.textContent = allDrivers.length;
      document.getElementById('totalCountChip').textContent = `${allDrivers.length}명`;
      showDriversOnMap(allDrivers);
      showToast('success','필터 초기화','모든 필터가 해제되었습니다.');
    }

    // ========= 탭/패널 =========
    function switchTab(e, tabName){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
      e.target.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    function toggleBottomPanel(force){
      const wantOpen = (typeof force==='boolean') ? force : !bottomPanelOpen;
      bottomPanelOpen = wantOpen;
      bottomPanel.classList.toggle('open', wantOpen);
      toggleBtn.textContent = wantOpen ? '▼' : '▲';
      if(map) setTimeout(()=>map.invalidateSize(),300);
    }

    function setupSearchFocus(){
      const si = document.getElementById('driverSearch');
      si.addEventListener('focus', ()=>{ if(!bottomPanelOpen) toggleBottomPanel(true); });
    }

    // ========= 포커스/정렬 =========
    function focusOnDriver(id){
      const d = allDrivers.find(x=>x.id===id);
      if(!d||!d.coordinates){ showToast('warning','위치 정보 없음','해당 기사의 위치 정보가 없습니다.'); return; }
      map.setView(d.coordinates,15);
      const mk = driverMarkers.get(d.id);
      if(mk) setTimeout(()=>mk.openPopup(),500);
      showToast('success','기사 포커스',`${d.name} 기사 위치로 이동했습니다.`);
    }

    function focusOnRegion(name){
      regionFilter.value = name;
      applyFilters();
      const arr = allDrivers.filter(d=>d.region===name && d.coordinates);
      if(arr.length){
        const bounds = L.latLngBounds(arr.map(d=>d.coordinates));
        map.fitBounds(bounds,{padding:[20,20]});
      }
      showToast('success',`${name} 지역`,`${name} 지역으로 포커스했습니다.`);
    }

    function sortTable(col){
      const order = (sortOrder[col]||'desc')==='asc'?'desc':'asc';
      sortOrder[col]=order;
      const sorted=[...allDrivers].sort((a,b)=>{
        let A=a[col], B=b[col];
        const isNum = (x)=> (typeof x==='number') || !isNaN(Number(x));
        if(isNum(A)||isNum(B)){ A=Number(A)||0; B=Number(B)||0; }
        else { A=String(A||'').toLowerCase(); B=String(B||'').toLowerCase(); }
        return order==='asc' ? (A>B?1:-1) : (A<B?1:-1);
      });
      allDrivers=sorted;
      renderDriverTable();
      applyFilters();
    }

    // ========= 액션 =========
    function copyPhoneNumbers(){
      const visible = [...rowById.entries()].filter(([_,row])=>!row.classList.contains('filtered-out'));
      const phones = visible.map(([id])=>{
        const d = allDrivers.find(x=>x.id===id);
        return d && d.phone && d.phone!=='-' ? d.phone : null;
      }).filter(Boolean);
      if(!phones.length){ showToast('warning','전화번호 없음','복사할 전화번호가 없습니다.'); return; }
      const text = phones.join('\n');
      navigator.clipboard.writeText(text).then(()=>{
        showToast('success','복사 완료',`${phones.length}개의 전화번호가 복사되었습니다.`);
      }).catch(()=>{
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        showToast('success','복사 완료',`${phones.length}개의 전화번호가 복사되었습니다.`);
      });
    }

    function openAppPush(){
      window.open('https://backoffice.drabbit.co.kr/apps/4a42193c-c779-11ef-aa21-cf70a380470e/Backoffice%202.1%20-%20Page/%ED%91%B8%EC%89%AC','_blank');
      showToast('success','App Push','App Push 페이지를 새 탭에서 열었습니다.');
    }

    function exportData(){
      const headers=['기사명','배송박스','운송사','전화번호','총건수','완료','실패','완료율','픽업여부','지연상태','지역'];
      const rows=[];
      for(const [id,row] of rowById.entries()){
        if(row.classList.contains('filtered-out')) continue;
        const d = allDrivers.find(x=>x.id===id);
        if(!d) continue;
        rows.push([d.name||'',d.deliveryBox||'',d.company||'',d.phone||'',d.totalDeliveries||0,d.completedDeliveries||0,d.failedDeliveries||0,d.completionRate||0,d.pickupStatus||'',d.delayStatus||'',d.region||''].join(','));
      }
      const blob = new Blob(['\uFEFF'+[headers.join(','),...rows].join('\n')],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); const url=URL.createObjectURL(blob);
      a.href=url; a.download=`딜리래빗_TMS_${new Date().toISOString().split('T')[0]}.csv`; a.style.visibility='hidden';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      showToast('success','내보내기 완료',`${rows.length}명의 기사 데이터가 다운로드되었습니다.`);
    }

    function showNotifications(){
      if(!tmsData||!tmsData.stats){ showToast('info','알림','데이터를 먼저 로드해주세요.'); return; }
      const s=tmsData.stats, msgs=[];
      if(s.delayedCount>0) msgs.push(`지연 기사 ${s.delayedCount}명`);
      if(s.notPickupCount>0) msgs.push(`미픽업 기사 ${s.notPickupCount}명`);
      if(s.overallCompletionRate<80) msgs.push(`전체 완료율 ${s.overallCompletionRate}% (주의 필요)`);
      if(!msgs.length) showToast('success','알림','현재 특별한 알림이 없습니다.');
      else showToast('warning','상황 알림',msgs.join(' | '));
    }

    // ========= 가이드 (자동 패널 오픈/복원 & 오프스크린 방지) =========
    function showGuide(){
      isGuideActive = true;
      currentGuideStep = 0;
      wasPanelOpenBeforeGuide = bottomPanelOpen;       // 상태 저장
      guideOverlay.classList.add('active');
      showGuideStep(0);
    }

    function showGuideStep(i){
      if(i>=guideSteps.length){ endGuide(); return; }
      const step=guideSteps[i];

      // 필요 시 하단 패널 자동 오픈
      if(step.openBottomPanel && !bottomPanelOpen){
        toggleBottomPanel(true);
      }

      // DOM 안정화 후 위치 계산
      setTimeout(()=>{
        const el=document.querySelector(step.element);
        if(!el){ nextGuide(); return; }

        el.scrollIntoView({behavior:'smooth',block:'center',inline:'center'});

        const rect=el.getBoundingClientRect();
        const highlight=document.getElementById('guideHighlight');
        highlight.style.top=rect.top+'px';
        highlight.style.left=rect.left+'px';
        highlight.style.width=rect.width+'px';
        highlight.style.height=rect.height+'px';
        highlight.classList.add('active');

        const tip=document.getElementById('guideTooltip');
        guideTitle.textContent=step.title;
        guideContent.textContent=step.content;

        const tipW=350, tipH=160, margin=16;
        let top = rect.bottom + margin;
        let left = clamp(rect.left, 16, window.innerWidth - tipW - 16);
        if(top + tipH > window.innerHeight - 16){ top = rect.top - tipH - margin; }
        if(top < 16) top = 16;

        tip.style.top = `${top}px`;
        tip.style.left = `${left}px`;

        const nextBtn=document.getElementById('guideNext');
        if(i===guideSteps.length-1){ nextBtn.textContent='완료'; nextBtn.className='guide-btn guide-btn-finish'; }
        else { nextBtn.textContent='다음'; nextBtn.className='guide-btn guide-btn-next'; }

        tip.classList.add('active');
      }, 220); // 패널 애니메이션/레이아웃 반영 후
    }

    function nextGuide(){ currentGuideStep++; showGuideStep(currentGuideStep); }

    function endGuide(){
      isGuideActive=false;
      guideOverlay.classList.remove('active');
      guideTooltip.classList.remove('active');
      guideHighlight.classList.remove('active');
      // 패널 상태 복원
      if(wasPanelOpenBeforeGuide===false && bottomPanelOpen){
        toggleBottomPanel(false);
      }
      showToast('success','가이드 종료','가이드를 완료했습니다.');
    }

    // ========= 토스트/자동새로고침/키보드 =========
    function showToast(type,title,msg){
      const t=document.getElementById('toast');
      t.className=`toast ${type} active`;
      toastTitle.textContent=title; toastMessage.textContent=msg;
      setTimeout(()=>t.classList.remove('active'),3000);
    }

    function startAutoRefresh(){
      if(autoRefreshInterval) clearInterval(autoRefreshInterval);
      autoRefreshInterval=setInterval(()=>{ loadGitHubData(); }, 300000);
    }

    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'&&bottomPanelOpen) toggleBottomPanel(false);
      if((e.ctrlKey||e.metaKey)&&e.key==='r'){ e.preventDefault(); loadGitHubData(); }
      if((e.ctrlKey||e.metaKey)&&e.key==='f'){ e.preventDefault(); if(!bottomPanelOpen) toggleBottomPanel(true); driverSearch.focus(); }
      if(e.key==='F1'){ e.preventDefault(); showGuide(); }
    });

    window.addEventListener('resize', ()=>{ if(map) setTimeout(()=>map.invalidateSize(),300); });
  </script>
</body>
</html>
