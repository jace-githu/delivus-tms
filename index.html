<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë”œë¦¬ë˜ë¹— TMS v3.1.1</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;background:#f5f5f7;color:#1d1d1f;overflow:hidden;height:100vh}
    .app-container{display:grid;grid-template-areas:"sidebar map map" "sidebar map map" "bottom bottom bottom";grid-template-columns:380px 1fr 1fr;grid-template-rows:1fr 1fr auto;height:100vh;gap:1px;background:#e5e5e5}
    .sidebar{grid-area:sidebar;background:#fff;display:flex;flex-direction:column;overflow:hidden;box-shadow:2px 0 8px rgba(0,0,0,.05)}
    .brand-header{padding:16px;border-bottom:1px solid #e5e5e5;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(to right,#f8f9fa,#fff)}
    .brand-logo{display:flex;align-items:center;gap:10px}
    .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,#6e6eff 0%,#5555dd 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
    .logo-text{font-size:16px;font-weight:700;color:#1d1d1f}
    .notification-btn{position:relative;width:36px;height:36px;border:1px solid #d1d1d6;border-radius:8px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:.2s}
    .notification-btn:hover{background:#f5f5f7;border-color:#6e6eff}
    .notification-badge{position:absolute;top:-4px;right:-4px;background:#ff3b30;color:#fff;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:600}
    .dashboard-section{padding:16px;background:#f8f9fa;border-bottom:1px solid #e5e5e5}
    .dashboard-title{font-size:13px;font-weight:600;color:#86868b;margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .stat-card{background:#fff;border:1px solid #e5e5e5;border-radius:8px;padding:14px;transition:.2s}
    .stat-card:hover{border-color:#6e6eff;box-shadow:0 2px 8px rgba(110,110,255,.1);transform:translateY(-1px)}
    .stat-label{font-size:11px;color:#86868b;margin-bottom:4px}
    .stat-value{font-size:24px;font-weight:700;margin-bottom:2px}
    .stat-value.primary{color:#6e6eff}.stat-value.success{color:#34c759}.stat-value.warning{color:#ff9500}.stat-value.danger{color:#ff3b30}
    .stat-change{font-size:10px;color:#86868b}
    .tabs-container{flex:1;display:flex;flex-direction:column;overflow:hidden}
    .tabs-nav{display:flex;background:#fff;border-bottom:1px solid #e5e5e5;padding:0 12px}
    .tab{padding:12px 16px;border:none;background:none;cursor:pointer;font-size:13px;font-weight:500;color:#666;border-bottom:2px solid transparent;transition:.2s;white-space:nowrap}
    .tab:hover{color:#6e6eff;background:#f5f5f7}
    .tab.active{color:#6e6eff;border-bottom-color:#6e6eff;font-weight:600}
    .tab-content-area{flex:1;overflow-y:auto;padding:16px;background:#fff}
    .tab-pane{display:none}.tab-pane.active{display:block}
    .refresh-section{padding:12px 16px;border-top:1px solid #e5e5e5;background:#fff}
    .btn-refresh{width:100%;padding:10px;border:1px solid #6e6eff;border-radius:8px;background:#fff;color:#6e6eff;font-size:14px;font-weight:500;cursor:pointer;transition:.2s}
    .btn-refresh:hover{background:#6e6eff;color:#fff}
    .map-container{grid-area:map;position:relative;background:#f5f5f7}
    #map{width:100%;height:100%}
    .map-controls{position:absolute;top:16px;right:16px;z-index:1000;display:flex;flex-direction:column;gap:8px}
    .map-btn{width:44px;height:44px;background:#fff;border:1px solid #d1d1d6;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.1);transition:.2s;font-size:20px;display:flex;align-items:center;justify-content:center}
    .map-btn:hover{background:#6e6eff;color:#fff;border-color:#6e6eff}
    .bottom-panel{grid-area:bottom;background:#fff;border-top:2px solid #e5e5e5;height:50px;transition:height .3s ease;overflow:hidden}
    .bottom-panel.open{height:350px}
    .panel-header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:#fafafa;cursor:pointer;user-select:none}
    .panel-header:hover{background:#f5f5f7}
    .panel-header-left{display:flex;align-items:center;gap:12px}
    .toggle-btn{width:24px;height:24px;border:1px solid #d1d1d6;border-radius:4px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;transition:.2s}
    .panel-title{font-size:14px;font-weight:600;color:#1d1d1f}
    /* ì „ì²´ ê¸°ì‚¬ ìˆ˜ ì¹© */
    .count-chip{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid #e5e5e5;border-radius:999px;padding:6px 10px;font-size:12px;color:#666}
    .count-chip strong{color:#1d1d1f}
    .panel-header-right{display:flex;align-items:center;gap:12px}
    .filter-bar{display:flex;align-items:center;gap:8px}
    .search-input{width:200px;padding:8px 12px;border:1px solid #d1d1d6;border-radius:6px;font-size:13px;outline:none}
    .search-input:focus{border-color:#6e6eff;box-shadow:0 0 0 3px rgba(110,110,255,.1)}
    .filter-select{padding:8px 12px;border:1px solid #d1d1d6;border-radius:6px;font-size:13px;cursor:pointer}
    .btn-sm{padding:8px 14px;border:1px solid #d1d1d6;border-radius:6px;background:#fff;font-size:13px;cursor:pointer;transition:.2s}
    .btn-sm:hover{background:#6e6eff;color:#fff;border-color:#6e6eff}
    .table-container{overflow:auto;height:280px;padding:0 20px 20px}
    .driver-table{width:100%;border-collapse:collapse;font-size:13px}
    .driver-table th{position:sticky;top:0;background:#fff;padding:12px 8px;text-align:left;font-size:11px;font-weight:600;color:#86868b;border-bottom:2px solid #e5e5e5;cursor:pointer;z-index:10}
    .driver-table th:hover{color:#6e6eff}
    .driver-table td{padding:10px 8px;border-bottom:1px solid #f5f5f7}
    .driver-table tbody tr{cursor:pointer;transition:background .2s}
    .driver-table tbody tr:hover{background:#f5f5f7}
    .driver-table tbody tr.filtered-out{display:none}
    .driver-name-clickable{color:#6e6eff;font-weight:600;cursor:pointer}
    .driver-name-clickable:hover{text-decoration:underline}
    .status-badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;display:inline-block}
    .status-pickup{background:#d1f4e0;color:#0f5132}
    .status-not-pickup{background:#fff3cd;color:#856404}
    .status-delayed{background:#ffe5e5;color:#c41e3a}
    .status-normal{background:#d1f4e0;color:#0f5132}
    .toast{position:fixed;bottom:24px;right:24px;background:#fff;border:1px solid #e5e5e5;border-radius:8px;padding:16px 20px;box-shadow:0 4px 12px rgba(0,0,0,.15);display:none;z-index:10001;min-width:300px}
    .toast.active{display:block;animation:slideIn .3s ease}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast.success{border-left:4px solid #34c759}.toast.error{border-left:4px solid #ff3b30}.toast.warning{border-left:4px solid #ff9500}.toast.info{border-left:4px solid #6e6eff}
    .toast-content{display:flex;flex-direction:column}
    .toast-title{font-weight:600;font-size:14px;margin-bottom:2px}
    .toast-message{font-size:13px;color:#666}
    .driver-card{background:#fff;border:1px solid #e5e5e5;border-radius:6px;padding:12px;margin-bottom:8px;cursor:pointer;transition:.2s}
    .driver-card:hover{border-color:#6e6eff;box-shadow:0 2px 8px rgba(110,110,255,.1)}
    .driver-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .driver-name{font-weight:600;font-size:14px;color:#1d1d1f}
    .driver-info{font-size:12px;color:#666;margin-bottom:4px}
    .region-item{background:#fff;border:1px solid #e5e5e5;border-radius:6px;padding:12px;margin-bottom:8px;cursor:pointer;transition:.2s}
    .region-item:hover{border-color:#6e6eff;transform:translateY(-1px)}
    .region-name{font-weight:600;font-size:14px;color:#6e6eff;margin-bottom:8px}
    .region-stats{display:flex;justify-content:space-between;font-size:12px;color:#666}
    ::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:#f5f5f7}::-webkit-scrollbar-thumb{background:#d1d1d6;border-radius:3px}::-webkit-scrollbar-thumb:hover{background:#86868b}
    .guide-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);z-index:10000;display:none}
    .guide-overlay.active{display:block}
    .guide-tooltip{position:fixed;background:linear-gradient(135deg,#6e6eff 0%,#5555dd 100%);color:#fff;padding:20px;border-radius:12px;max-width:350px;z-index:10001;box-shadow:0 8px 32px rgba(110,110,255,.4);opacity:0;transform:scale(.9);transition:.2s}
    .guide-tooltip.active{opacity:1;transform:scale(1)}
    .guide-tooltip-header{font-size:18px;font-weight:700;margin-bottom:12px}
    .guide-tooltip-content{font-size:14px;line-height:1.6;margin-bottom:16px;white-space:pre-line}
    .guide-buttons{display:flex;gap:8px;justify-content:space-between}
    .guide-btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:.2s}
    .guide-btn-skip{background:rgba(255,255,255,.2);color:#fff}.guide-btn-next{background:#fff;color:#6e6eff}.guide-btn-finish{background:#34c759;color:#fff}
    .guide-highlight{position:fixed;border:3px solid #6e6eff;border-radius:8px;pointer-events:none;z-index:9999;box-shadow:0 0 0 4px rgba(110,110,255,.3);display:none}
    .guide-highlight.active{display:block}
    @media (max-width:1200px){.app-container{grid-template-columns:280px 1fr 1fr}}
    @media (max-width:768px){
      .app-container{grid-template-areas:"sidebar" "map" "bottom";grid-template-columns:1fr;grid-template-rows:auto 400px auto}
      .sidebar{height:auto;max-height:50vh;overflow-y:auto}
    }
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="brand-header">
        <div class="brand-logo">
          <div class="logo-icon">D</div>
          <span class="logo-text">ë”œë¦¬ë˜ë¹— TMS</span>
        </div>
        <button class="notification-btn" onclick="showNotifications()">ğŸ””
          <span class="notification-badge" id="notificationCount">0</span>
        </button>
      </div>

      <div class="dashboard-section">
        <h3 class="dashboard-title">ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</h3>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label">ì´ ë°°ì†¡</div><div class="stat-value primary" id="totalOrders">0</div><div class="stat-change">ì „ì²´ ë°°ì†¡ëŸ‰</div></div>
          <div class="stat-card"><div class="stat-label">ì™„ë£Œ</div><div class="stat-value success" id="completedDeliveries">0</div><div class="stat-change">ë°°ì†¡ ì™„ë£Œ</div></div>
          <div class="stat-card"><div class="stat-label">ì§„í–‰ì¤‘</div><div class="stat-value warning" id="inProgress">0</div><div class="stat-change">ë°°ì†¡ ì§„í–‰</div></div>
          <div class="stat-card"><div class="stat-label">ì§€ì—°</div><div class="stat-value danger" id="delayedCount">0</div><div class="stat-change">20ë¶„ ì´ìƒ</div></div>
          <div class="stat-card"><div class="stat-label">ì™„ë£Œìœ¨</div><div class="stat-value success" id="overallCompletionRate">0%</div><div class="stat-change">ì „ì²´ ì™„ë£Œìœ¨</div></div>
          <div class="stat-card"><div class="stat-label">ì‹¤íŒ¨ ê±´ìˆ˜</div><div class="stat-value danger" id="failedDeliveries">0</div><div class="stat-change">ì²˜ë¦¬ í•„ìš”</div></div>
        </div>
      </div>

      <div class="tabs-container">
        <nav class="tabs-nav">
          <button class="tab active" onclick="switchTab(event,'monitor')">ì‹¤ì‹œê°„ê´€ì œ</button>
          <button class="tab" onclick="switchTab(event,'drivers')">ê¸°ì‚¬ê´€ë¦¬</button>
          <button class="tab" onclick="switchTab(event,'regions')">ì§€ì—­í˜„í™©</button>
          <button class="tab" onclick="switchTab(event,'stats')">í†µê³„ë¶„ì„</button>
        </nav>

        <div class="tab-content-area">
          <div id="tab-monitor" class="tab-pane active"><h4 style="font-size:14px;font-weight:600;margin-bottom:12px;">âš ï¸ ê´€ì œ í•„ìš”</h4><div id="alertList"></div></div>
          <div id="tab-drivers" class="tab-pane"><div id="driversList"></div></div>
          <div id="tab-regions" class="tab-pane"><div id="regionsList"></div></div>
          <div id="tab-stats" class="tab-pane"><h4 style="font-size:14px;font-weight:600;margin-bottom:12px;">ìš´ì†¡ì‚¬ë³„ ì„±ê³¼</h4><div id="companyStats"></div></div>
        </div>
      </div>

      <div class="refresh-section">
        <button class="btn-refresh" onclick="loadGitHubData()">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </aside>

    <main class="map-container">
      <div id="map"></div>
      <div class="map-controls">
        <button class="map-btn" onclick="resetMapView()" title="ì „ì²´ë³´ê¸°">ğŸŒ</button>
        <button class="map-btn" onclick="showGuide()" title="ê°€ì´ë“œ">ğŸ“–</button>
      </div>
    </main>

    <section class="bottom-panel" id="bottomPanel">
      <div class="panel-header" onclick="toggleBottomPanel()">
        <div class="panel-header-left">
          <button class="toggle-btn" id="toggleBtn" onclick="event.stopPropagation();toggleBottomPanel()">â–²</button>
          <h3 class="panel-title">ìƒì„¸ í˜„í™©</h3>
          <!-- ì „ì²´ ê¸°ì‚¬ ìˆ˜ ì¹© -->
          <div class="count-chip" onclick="event.stopPropagation()">
            ì „ì²´ ê¸°ì‚¬ ìˆ˜ <strong id="totalCountChip">0ëª…</strong>
          </div>
        </div>
        <div class="panel-header-right">
          <div class="filter-bar" onclick="event.stopPropagation()">
            <input type="text" class="search-input" placeholder="ê¸°ì‚¬ëª…, ì „í™”ë²ˆí˜¸ ê²€ìƒ‰" id="driverSearch">
            <select class="filter-select" id="controlFilter" onchange="applyFilters()">
              <option value="">ì „ì²´ ê´€ì œ</option><option value="ì§€ì—°">ì§€ì—°</option><option value="ë¯¸í”½ì—…">ë¯¸í”½ì—…</option>
            </select>
            <select class="filter-select" id="companyFilter" onchange="applyFilters()"><option value="">ì „ì²´ ìš´ì†¡ì‚¬</option></select>
            <select class="filter-select" id="regionFilter" onchange="applyFilters()"><option value="">ì „ì²´ ì§€ì—­</option></select>
            <button class="btn-sm" onclick="event.stopPropagation();resetFilters()">â†» ì´ˆê¸°í™”</button>
          </div>
          <!-- ë²„íŠ¼ë“¤: íŒ¨ë„ í† ê¸€ ë°©ì§€ -->
          <button class="btn-sm" onclick="event.stopPropagation();copyPhoneNumbers()">ğŸ“ ë²ˆí˜¸ë³µì‚¬</button>
          <button class="btn-sm" onclick="event.stopPropagation();openAppPush()">ğŸ“± App Push</button>
          <button class="btn-sm" onclick="event.stopPropagation();exportData()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
          <span style="margin-left:12px;font-size:13px;color:#666;"><strong id="visibleCount">0</strong> / <span id="totalCount">0</span></span>
        </div>
      </div>

      <div class="table-container">
        <table class="driver-table">
          <thead>
            <tr>
              <th onclick="sortTable('name')">ê¸°ì‚¬ëª… <span class="sort-icon">â†•</span></th>
              <th onclick="sortTable('deliveryBox')">ë°°ì†¡ë°•ìŠ¤ <span class="sort-icon">â†•</span></th>
              <th onclick="sortTable('company')">ìš´ì†¡ì‚¬ <span class="sort-icon">â†•</span></th>
              <th onclick="sortTable('phone')">ì „í™”ë²ˆí˜¸ <span class="sort-icon">â†•</span></th>
              <th onclick="sortTable('totalDeliveries')">ì´ê±´ìˆ˜ <span class="sort-icon">â†•</span></th>
              <th onclick="sortTable('completedDeliveries')">ì™„ë£Œ <span class="sort-icon">â†•</span></th>
              <th onclick="sortTable('failedDeliveries')">ì‹¤íŒ¨ <span class="sort-icon">â†•</span></th>
              <th onclick="sortTable('completionRate')">ì™„ë£Œìœ¨ <span class="sort-icon">â†•</span></th>
              <th onclick="sortTable('pickupStatus')">í”½ì—…ì—¬ë¶€ <span class="sort-icon">â†•</span></th>
              <th onclick="sortTable('delayStatus')">ì§€ì—°(20ë¶„) <span class="sort-icon">â†•</span></th>
              <th onclick="sortTable('region')">ì§€ì—­ <span class="sort-icon">â†•</span></th>
            </tr>
          </thead>
          <tbody id="driverTableBody">
            <tr><td colspan="11" style="text-align:center;padding:2rem;">ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="toast" class="toast">
    <div class="toast-content">
      <div class="toast-title" id="toastTitle">ì•Œë¦¼</div>
      <div class="toast-message" id="toastMessage">ë©”ì‹œì§€</div>
    </div>
  </div>

  <div class="guide-overlay" id="guideOverlay"></div>
  <div class="guide-tooltip" id="guideTooltip">
    <div class="guide-tooltip-header" id="guideTitle">ê°€ì´ë“œ</div>
    <div class="guide-tooltip-content" id="guideContent">ë‚´ìš©</div>
    <div class="guide-buttons">
      <button class="guide-btn guide-btn-skip" onclick="endGuide()">ê±´ë„ˆë›°ê¸°</button>
      <button class="guide-btn guide-btn-next" id="guideNext" onclick="nextGuide()">ë‹¤ìŒ</button>
    </div>
  </div>
  <div class="guide-highlight" id="guideHighlight"></div>

  <script>
    // ========= ì „ì—­ =========
    let map, markerCluster;
    let driverMarkers = new Map();
    let tmsData = null;
    let allDrivers = [];
    let sortOrder = {};
    let bottomPanelOpen = false;
    let autoRefreshInterval = null;
    let currentGuideStep = 0;
    let isGuideActive = false;
    let wasPanelOpenBeforeGuide = null;   // [NEW] ê°€ì´ë“œ ì‹œì‘ ì „ ìƒíƒœ ì €ì¥

    // ê²€ìƒ‰ ì¸ë±ìŠ¤ & DOM ìºì‹œ
    let searchIndex = [];
    let rowById = new Map();
    let lastFilteredIds = null;

    const GITHUB_CONFIG = { owner:'jace-githu', repo:'delivus-tms', path:'data/tms_data.json', branch:'main' };

    // === ê¸°ëŠ¥ ìœ„ì£¼ ê°€ì´ë“œ (ìŠ¬ë¦¼í™”) ===
    const guideSteps = [
      { element: '.dashboard-section', title: 'ğŸ“Š ëŒ€ì‹œë³´ë“œ', content: 'ì´ ë°°ì†¡/ì™„ë£Œ/ì§€ì—° ë“± í•µì‹¬ ì§€í‘œë¥¼ ì¦‰ì‹œ í™•ì¸í•©ë‹ˆë‹¤.' },
      { element: '.tabs-nav',         title: 'ğŸ“‘ íƒ­ ì „í™˜', content: 'ì‹¤ì‹œê°„ê´€ì œ/ê¸°ì‚¬ê´€ë¦¬/ì§€ì—­í˜„í™©/í†µê³„ë¶„ì„ìœ¼ë¡œ í•„ìš”í•œ ì •ë³´ë¥¼ ë¹ ë¥´ê²Œ ì°¾ìŠµë‹ˆë‹¤.' },
      { element: '#map',              title: 'ğŸ—ºï¸ ì§€ë„ ê´€ì œ', content: 'ë§ˆì»¤ ìƒ‰ìƒ ì˜ë¯¸\nâ€¢ íšŒìƒ‰ 100% ì™„ë£Œ\nâ€¢ ì´ˆë¡ ì •ìƒ\nâ€¢ ì£¼í™© ë¯¸í”½ì—…\nâ€¢ ë¹¨ê°• ì§€ì—°' },
      { element: '.map-controls',     title: 'ğŸ›ï¸ ì§€ë„ ì»¨íŠ¸ë¡¤', content: 'ğŸŒ ì „ì²´ë³´ê¸°, ğŸ“– ê°€ì´ë“œ í˜¸ì¶œì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.' },
      { element: '.panel-header',     title: 'â–¼ ìƒì„¸ í˜„í™© ì—´ê¸°', content: 'í´ë¦­í•˜ì—¬ í•˜ë‹¨ ìƒì„¸ í…Œì´ë¸”ì„ í¼ì¹©ë‹ˆë‹¤.', openBottomPanel: true },
      { element: '#driverSearch',     title: 'ğŸ” í†µí•© ê²€ìƒ‰', content: 'ê¸°ì‚¬ëª…/ì „í™”ë²ˆí˜¸ ê²€ìƒ‰ ì‹œ í…Œì´ë¸”ê³¼ ì§€ë„ê°€ í•¨ê»˜ í•„í„°ë§ë©ë‹ˆë‹¤.', openBottomPanel: true },
      { element: '.filter-bar',       title: 'ğŸ¯ í•„í„°', content: 'ê´€ì œ ìƒíƒœ/ìš´ì†¡ì‚¬/ì§€ì—­ë³„ë¡œ ì¢í˜€ë³´ê¸°. â†» ì´ˆê¸°í™”ë¡œ ì›ë³µ.', openBottomPanel: true },
      { element: '.driver-table',     title: 'ğŸ“‹ ì •ë ¬Â·í¬ì»¤ìŠ¤', content: 'í—¤ë” í´ë¦­ ì •ë ¬, ê¸°ì‚¬ëª… í´ë¦­ ì‹œ ì§€ë„ì—ì„œ ìœ„ì¹˜ í¬ì»¤ìŠ¤.', openBottomPanel: true },
      { element: '.panel-header-right',title:'âš¡ ë¹ ë¥¸ ì•¡ì…˜', content:'ğŸ“ë²ˆí˜¸ë³µì‚¬ / ğŸ“±App Push / ğŸ“¥CSV ë‚´ë³´ë‚´ê¸°', openBottomPanel: true }
    ];

    // ========= ìœ í‹¸ =========
    const debounce = (fn, delay=200) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),delay); }; };
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const toDigits = s => (s||'').replace(/[^0-9]/g,'');

    // ========= ì´ˆê¸°í™” =========
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      bindSearchInput();
      loadGitHubData();
      startAutoRefresh();
      setupSearchFocus();
    });

    // ========= ì§€ë„ =========
    function initMap(){
      map = L.map('map',{preferCanvas:true,zoomControl:true,attributionControl:false})
              .setView([37.5665,126.9780],11);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'Â© OpenStreetMap', maxZoom:18, minZoom:8, updateWhenIdle:false, updateWhenZooming:false
      }).addTo(map);

      markerCluster = L.markerClusterGroup({
        maxClusterRadius:50, disableClusteringAtZoom:14, spiderfyOnMaxZoom:true,
        showCoverageOnHover:false, zoomToBoundsOnClick:true,
        chunkedLoading:true, chunkInterval:200, chunkDelay:50,
        iconCreateFunction(cluster){
          const n = cluster.getChildCount();
          const size = n<10?30:n<25?35:40;
          return new L.DivIcon({
            html:`<div style="background:linear-gradient(135deg,#6e6eff 0%,#5555dd 100%);width:${size}px;height:${size}px;border-radius:50%;border:2px solid #fff;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:${size<35?12:14}px;box-shadow:0 2px 8px rgba(110,110,255,.4);">${n}</div>`,
            className:'marker-cluster', iconSize:new L.Point(size,size)
          });
        }
      });
      map.addLayer(markerCluster);
    }

    function resetMapView(){
      map.setView([37.5665,126.9780],11);
      resetFilters();
      showToast('success','ì „ì²´ ì§€ë„','ì „ì²´ ë³´ê¸°ë¡œ ëŒì•„ê°”ìŠµë‹ˆë‹¤.');
    }

    // ========= ë°ì´í„° ë¡œë“œ =========
    async function loadGitHubData(){
      try{
        const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}?t=${Date.now()}`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const rawText = await res.text();
        tmsData = JSON.parse(rawText);
        allDrivers = tmsData.drivers||[];

        buildSearchIndex();
        updateDashboard();
        updateTabs();
        renderDriverTable();
        updateFilterOptions();
        showDriversOnMap(allDrivers,true);

        showToast('success','ë°ì´í„° ë¡œë“œ ì™„ë£Œ',`${allDrivers.length}ëª…ì˜ ê¸°ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
      }catch(e){
        console.error(e);
        showToast('error','ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨',e.message);
      }
    }

    // ========= ì¸ë±ì‹± / í…Œì´ë¸” =========
    function buildSearchIndex(){
      searchIndex = allDrivers.map(d=>({
        id:d.id,
        nameL:(d.name||'').toLowerCase(),
        nameNS:(d.name||'').replace(/\s+/g,'').toLowerCase(),
        phoneD:toDigits(d.phone)
      }));
    }

    function renderDriverTable(){
      const tbody = document.getElementById('driverTableBody');
      rowById.clear();
      const frag = document.createDocumentFragment();
      allDrivers.forEach(d=>{
        const tr = document.createElement('tr');
        tr.setAttribute('data-driver-id', d.id);
        tr.innerHTML = `
          <td><strong class="driver-name-clickable" onclick="focusOnDriver('${d.id}')">${d.name||''}</strong></td>
          <td>${d.deliveryBox||'-'}</td>
          <td>${d.company||'-'}</td>
          <td>${d.phone||'-'}</td>
          <td style="color:#6e6eff;font-weight:600;">${d.totalDeliveries||0}</td>
          <td style="color:#34c759;font-weight:600;">${d.completedDeliveries||0}</td>
          <td style="color:#ff3b30;font-weight:600;">${d.failedDeliveries||0}</td>
          <td><strong>${d.completionRate||0}%</strong></td>
          <td><span class="status-badge ${d.pickupStatus==='í”½ì—…'?'status-pickup':'status-not-pickup'}">${d.pickupStatus||'ë¯¸í”½ì—…'}</span></td>
          <td><span class="status-badge ${d.delayStatus==='ì§€ì—°'?'status-delayed':'status-normal'}">${d.delayStatus||'ì •ìƒ'}</span></td>
          <td>${d.region||'-'}</td>
        `;
        frag.appendChild(tr);
        rowById.set(d.id, tr);
      });
      tbody.innerHTML = '';
      tbody.appendChild(frag);

      // ì´/ê°€ì‹œ ìˆ˜ ê°±ì‹  + ì¹© ì—…ë°ì´íŠ¸
      document.getElementById('totalCount').textContent = allDrivers.length;
      document.getElementById('visibleCount').textContent = allDrivers.length;
      document.getElementById('totalCountChip').textContent = `${allDrivers.length}ëª…`;

      lastFilteredIds = new Set(allDrivers.map(d=>d.id));
    }

    // ========= ëŒ€ì‹œë³´ë“œ/íƒ­/í•„í„° =========
    function updateDashboard(){
      if(!tmsData||!tmsData.stats) return;
      const s=tmsData.stats;
      totalOrders.textContent=s.totalOrders||0;
      completedDeliveries.textContent=s.completedDeliveries||0;
      inProgress.textContent=s.inProgress||0;
      delayedCount.textContent=s.delayedCount||0;
      overallCompletionRate.textContent=(s.overallCompletionRate||0)+'%';
      failedDeliveries.textContent=s.failedDeliveries||0;
      notificationCount.textContent=(s.delayedCount||0)+(s.notPickupCount||0);
    }

    function updateTabs(){
      const alertDrivers = allDrivers.filter(d=>d.delayStatus==='ì§€ì—°'||d.pickupStatus==='ë¯¸í”½ì—…').slice(0,10);
      alertList.innerHTML = alertDrivers.length
        ? alertDrivers.map(d=>`
            <div class="alert-card ${d.delayStatus==='ì§€ì—°'?'danger':''}" onclick="focusOnDriver('${d.id}')">
              <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                <strong>${d.name}</strong><span>${d.delayStatus==='ì§€ì—°'?'ğŸ”´ ì§€ì—°':'ğŸŸ¡ ë¯¸í”½ì—…'}</span>
              </div>
              <div style="font-size:11px;color:#666;">${d.company} | ${d.region} | ì™„ë£Œìœ¨ ${d.completionRate}%</div>
            </div>`).join('')
        : '<div style="text-align:center;padding:20px;color:#86868b;">ê´€ì œê°€ í•„ìš”í•œ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤ âœ“</div>';

      const driverHtml = allDrivers.slice(0,15).map(d=>`
        <div class="driver-card" onclick="focusOnDriver('${d.id}')">
          <div class="driver-card-header">
            <span class="driver-name">${d.name}</span>
            <span class="status-badge ${d.delayStatus==='ì§€ì—°'?'status-delayed':(d.pickupStatus==='í”½ì—…'?'status-pickup':'status-not-pickup')}">
              ${d.delayStatus==='ì§€ì—°'?'ì§€ì—°':d.pickupStatus}
            </span>
          </div>
          <div class="driver-info">ğŸ“¦ ${d.completedDeliveries}/${d.totalDeliveries} (${d.completionRate}%)</div>
          <div class="driver-info">${d.company} | ${d.region}</div>
        </div>`).join('');
      driversList.innerHTML = driverHtml;

      if(tmsData.regions){
        regionsList.innerHTML = tmsData.regions.map(r=>`
          <div class="region-item" onclick="focusOnRegion('${r.name}')">
            <div class="region-name">${r.name}</div>
            <div class="region-stats"><span>ì™„ë£Œ: ${r.delivered||0}</span><span>ì§„í–‰: ${r.transit||0}</span><span>ì™„ë£Œìœ¨: ${r.completionRate||0}%</span></div>
          </div>`).join('');
      }
    }

    function updateFilterOptions(){
      const companies=[...new Set(allDrivers.map(d=>d.company).filter(Boolean))].sort();
      const regions=[...new Set(allDrivers.map(d=>d.region).filter(Boolean))].sort();
      companyFilter.innerHTML = '<option value="">ì „ì²´ ìš´ì†¡ì‚¬</option>'+companies.map(c=>`<option value="${c}">${c}</option>`).join('');
      regionFilter.innerHTML = '<option value="">ì „ì²´ ì§€ì—­</option>'+regions.map(r=>`<option value="${r}">${r}</option>`).join('');
    }

    // ========= ì§€ë„ ë§ˆì»¤ =========
    function showDriversOnMap(drivers, force=false){
      if(!map||!drivers) return;
      const newIds = new Set(drivers.map(d=>d.id));
      const same = lastFilteredIds && newIds.size===lastFilteredIds.size && [...newIds].every(id=>lastFilteredIds.has(id));
      if(!force && same) return;

      markerCluster.clearLayers();
      driverMarkers.clear();

      const markers = [];
      for(const d of drivers){
        if(!d.coordinates || d.coordinates.length!==2) continue;
        const isCompleted = Number(d.completionRate||0)===100;
        const color = isCompleted ? '#9ca3af' : (d.delayStatus==='ì§€ì—°'?'#ff3b30':(d.pickupStatus==='ë¯¸í”½ì—…'?'#ff9500':'#34c759'));
        const icon = L.divIcon({
          className:'driver-marker',
          html:`<div style="background:${color};width:16px;height:16px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.3);"></div>`,
          iconSize:[20,20], iconAnchor:[10,10]
        });
        const mk = L.marker(d.coordinates,{icon}).bindPopup(
          `<div style="font-size:12px;"><strong style="color:#6e6eff;">${d.name}</strong><br>ğŸ“¦ ${d.deliveryBox||'-'}<br>ğŸ“± ${d.phone||''}<br>ì™„ë£Œ: ${d.completedDeliveries}/${d.totalDeliveries} (${d.completionRate}%)</div>`,
          {maxWidth:200}
        );
        markers.push(mk);
        driverMarkers.set(d.id, mk);
      }
      if(markers.length) markerCluster.addLayers(markers);
      lastFilteredIds = newIds;
    }

    // ========= ê²€ìƒ‰/í•„í„° =========
    function bindSearchInput(){
      const handler = debounce(()=>{
        const term = driverSearch.value.trim().toLowerCase();
        if(!term){
          for(const [id,row] of rowById.entries()) row.classList.remove('filtered-out');
          visibleCount.textContent = allDrivers.length;
          document.getElementById('totalCountChip').textContent = `${allDrivers.length}ëª…`;
          showDriversOnMap(allDrivers);
          return;
        }
        const termNS = term.replace(/\s+/g,'');
        const termD  = toDigits(term);

        let visible = 0;
        const matchedIds = [];
        for(const ix of searchIndex){
          const nameMatch = ix.nameL.includes(term) || ix.nameNS.includes(termNS) || [...term].every(c=>ix.nameL.includes(c));
          const phoneMatch = termD && ix.phoneD.includes(termD);
          const ok = nameMatch || phoneMatch;
          const row = rowById.get(ix.id);
          if(!row) continue;
          if(ok){ row.classList.remove('filtered-out'); visible++; matchedIds.push(ix.id); }
          else  { row.classList.add('filtered-out'); }
        }
        visibleCount.textContent = visible;
        showDriversOnMap(allDrivers.filter(d=>matchedIds.includes(d.id)));
      },200);
      driverSearch.addEventListener('input', handler);
    }

    function applyFilters(){
      const cF = controlFilter.value, compF = companyFilter.value, rF = regionFilter.value;
      const filtered = allDrivers.filter(d=>{
        const a = !compF || d.company===compF;
        const b = !rF || d.region===rF;
        let c = true;
        if(cF==='ì§€ì—°') c = d.delayStatus==='ì§€ì—°' && Number(d.completionRate||0)<100;
        else if(cF==='ë¯¸í”½ì—…') c = d.pickupStatus==='ë¯¸í”½ì—…';
        return a && b && c;
      });

      for(const [id,row] of rowById.entries()){
        row.classList.toggle('filtered-out', !filtered.some(d=>d.id===id));
      }
      visibleCount.textContent = filtered.length;
      // ì´ ì¹©ì€ ì „ì²´ ìˆ˜ë¥¼ í‘œí˜„(ìš”ì²­ì‚¬í•­), ìœ ì§€
      document.getElementById('totalCountChip').textContent = `${allDrivers.length}ëª…`;
      showDriversOnMap(filtered);
    }

    function resetFilters(){
      controlFilter.value=''; companyFilter.value=''; regionFilter.value=''; driverSearch.value='';
      for(const [_,row] of rowById.entries()) row.classList.remove('filtered-out');
      visibleCount.textContent = allDrivers.length;
      document.getElementById('totalCountChip').textContent = `${allDrivers.length}ëª…`;
      showDriversOnMap(allDrivers);
      showToast('success','í•„í„° ì´ˆê¸°í™”','ëª¨ë“  í•„í„°ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ========= íƒ­/íŒ¨ë„ =========
    function switchTab(e, tabName){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
      e.target.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    function toggleBottomPanel(force){
      const wantOpen = (typeof force==='boolean') ? force : !bottomPanelOpen;
      bottomPanelOpen = wantOpen;
      bottomPanel.classList.toggle('open', wantOpen);
      toggleBtn.textContent = wantOpen ? 'â–¼' : 'â–²';
      if(map) setTimeout(()=>map.invalidateSize(),300);
    }

    function setupSearchFocus(){
      const si = document.getElementById('driverSearch');
      si.addEventListener('focus', ()=>{ if(!bottomPanelOpen) toggleBottomPanel(true); });
    }

    // ========= í¬ì»¤ìŠ¤/ì •ë ¬ =========
    function focusOnDriver(id){
      const d = allDrivers.find(x=>x.id===id);
      if(!d||!d.coordinates){ showToast('warning','ìœ„ì¹˜ ì •ë³´ ì—†ìŒ','í•´ë‹¹ ê¸°ì‚¬ì˜ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      map.setView(d.coordinates,15);
      const mk = driverMarkers.get(d.id);
      if(mk) setTimeout(()=>mk.openPopup(),500);
      showToast('success','ê¸°ì‚¬ í¬ì»¤ìŠ¤',`${d.name} ê¸°ì‚¬ ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`);
    }

    function focusOnRegion(name){
      regionFilter.value = name;
      applyFilters();
      const arr = allDrivers.filter(d=>d.region===name && d.coordinates);
      if(arr.length){
        const bounds = L.latLngBounds(arr.map(d=>d.coordinates));
        map.fitBounds(bounds,{padding:[20,20]});
      }
      showToast('success',`${name} ì§€ì—­`,`${name} ì§€ì—­ìœ¼ë¡œ í¬ì»¤ìŠ¤í–ˆìŠµë‹ˆë‹¤.`);
    }

    function sortTable(col){
      const order = (sortOrder[col]||'desc')==='asc'?'desc':'asc';
      sortOrder[col]=order;
      const sorted=[...allDrivers].sort((a,b)=>{
        let A=a[col], B=b[col];
        const isNum = (x)=> (typeof x==='number') || !isNaN(Number(x));
        if(isNum(A)||isNum(B)){ A=Number(A)||0; B=Number(B)||0; }
        else { A=String(A||'').toLowerCase(); B=String(B||'').toLowerCase(); }
        return order==='asc' ? (A>B?1:-1) : (A<B?1:-1);
      });
      allDrivers=sorted;
      renderDriverTable();
      applyFilters();
    }

    // ========= ì•¡ì…˜ =========
    function copyPhoneNumbers(){
      const visible = [...rowById.entries()].filter(([_,row])=>!row.classList.contains('filtered-out'));
      const phones = visible.map(([id])=>{
        const d = allDrivers.find(x=>x.id===id);
        return d && d.phone && d.phone!=='-' ? d.phone : null;
      }).filter(Boolean);
      if(!phones.length){ showToast('warning','ì „í™”ë²ˆí˜¸ ì—†ìŒ','ë³µì‚¬í•  ì „í™”ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const text = phones.join('\n');
      navigator.clipboard.writeText(text).then(()=>{
        showToast('success','ë³µì‚¬ ì™„ë£Œ',`${phones.length}ê°œì˜ ì „í™”ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }).catch(()=>{
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        showToast('success','ë³µì‚¬ ì™„ë£Œ',`${phones.length}ê°œì˜ ì „í™”ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      });
    }

    function openAppPush(){
      window.open('https://backoffice.drabbit.co.kr/apps/4a42193c-c779-11ef-aa21-cf70a380470e/Backoffice%202.1%20-%20Page/%ED%91%B8%EC%89%AC','_blank');
      showToast('success','App Push','App Push í˜ì´ì§€ë¥¼ ìƒˆ íƒ­ì—ì„œ ì—´ì—ˆìŠµë‹ˆë‹¤.');
    }

    function exportData(){
      const headers=['ê¸°ì‚¬ëª…','ë°°ì†¡ë°•ìŠ¤','ìš´ì†¡ì‚¬','ì „í™”ë²ˆí˜¸','ì´ê±´ìˆ˜','ì™„ë£Œ','ì‹¤íŒ¨','ì™„ë£Œìœ¨','í”½ì—…ì—¬ë¶€','ì§€ì—°ìƒíƒœ','ì§€ì—­'];
      const rows=[];
      for(const [id,row] of rowById.entries()){
        if(row.classList.contains('filtered-out')) continue;
        const d = allDrivers.find(x=>x.id===id);
        if(!d) continue;
        rows.push([d.name||'',d.deliveryBox||'',d.company||'',d.phone||'',d.totalDeliveries||0,d.completedDeliveries||0,d.failedDeliveries||0,d.completionRate||0,d.pickupStatus||'',d.delayStatus||'',d.region||''].join(','));
      }
      const blob = new Blob(['\uFEFF'+[headers.join(','),...rows].join('\n')],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); const url=URL.createObjectURL(blob);
      a.href=url; a.download=`ë”œë¦¬ë˜ë¹—_TMS_${new Date().toISOString().split('T')[0]}.csv`; a.style.visibility='hidden';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      showToast('success','ë‚´ë³´ë‚´ê¸° ì™„ë£Œ',`${rows.length}ëª…ì˜ ê¸°ì‚¬ ë°ì´í„°ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    function showNotifications(){
      if(!tmsData||!tmsData.stats){ showToast('info','ì•Œë¦¼','ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.'); return; }
      const s=tmsData.stats, msgs=[];
      if(s.delayedCount>0) msgs.push(`ì§€ì—° ê¸°ì‚¬ ${s.delayedCount}ëª…`);
      if(s.notPickupCount>0) msgs.push(`ë¯¸í”½ì—… ê¸°ì‚¬ ${s.notPickupCount}ëª…`);
      if(s.overallCompletionRate<80) msgs.push(`ì „ì²´ ì™„ë£Œìœ¨ ${s.overallCompletionRate}% (ì£¼ì˜ í•„ìš”)`);
      if(!msgs.length) showToast('success','ì•Œë¦¼','í˜„ì¬ íŠ¹ë³„í•œ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.');
      else showToast('warning','ìƒí™© ì•Œë¦¼',msgs.join(' | '));
    }

    // ========= ê°€ì´ë“œ (ìë™ íŒ¨ë„ ì˜¤í”ˆ/ë³µì› & ì˜¤í”„ìŠ¤í¬ë¦° ë°©ì§€) =========
    function showGuide(){
      isGuideActive = true;
      currentGuideStep = 0;
      wasPanelOpenBeforeGuide = bottomPanelOpen;       // ìƒíƒœ ì €ì¥
      guideOverlay.classList.add('active');
      showGuideStep(0);
    }

    function showGuideStep(i){
      if(i>=guideSteps.length){ endGuide(); return; }
      const step=guideSteps[i];

      // í•„ìš” ì‹œ í•˜ë‹¨ íŒ¨ë„ ìë™ ì˜¤í”ˆ
      if(step.openBottomPanel && !bottomPanelOpen){
        toggleBottomPanel(true);
      }

      // DOM ì•ˆì •í™” í›„ ìœ„ì¹˜ ê³„ì‚°
      setTimeout(()=>{
        const el=document.querySelector(step.element);
        if(!el){ nextGuide(); return; }

        el.scrollIntoView({behavior:'smooth',block:'center',inline:'center'});

        const rect=el.getBoundingClientRect();
        const highlight=document.getElementById('guideHighlight');
        highlight.style.top=rect.top+'px';
        highlight.style.left=rect.left+'px';
        highlight.style.width=rect.width+'px';
        highlight.style.height=rect.height+'px';
        highlight.classList.add('active');

        const tip=document.getElementById('guideTooltip');
        guideTitle.textContent=step.title;
        guideContent.textContent=step.content;

        const tipW=350, tipH=160, margin=16;
        let top = rect.bottom + margin;
        let left = clamp(rect.left, 16, window.innerWidth - tipW - 16);
        if(top + tipH > window.innerHeight - 16){ top = rect.top - tipH - margin; }
        if(top < 16) top = 16;

        tip.style.top = `${top}px`;
        tip.style.left = `${left}px`;

        const nextBtn=document.getElementById('guideNext');
        if(i===guideSteps.length-1){ nextBtn.textContent='ì™„ë£Œ'; nextBtn.className='guide-btn guide-btn-finish'; }
        else { nextBtn.textContent='ë‹¤ìŒ'; nextBtn.className='guide-btn guide-btn-next'; }

        tip.classList.add('active');
      }, 220); // íŒ¨ë„ ì• ë‹ˆë©”ì´ì…˜/ë ˆì´ì•„ì›ƒ ë°˜ì˜ í›„
    }

    function nextGuide(){ currentGuideStep++; showGuideStep(currentGuideStep); }

    function endGuide(){
      isGuideActive=false;
      guideOverlay.classList.remove('active');
      guideTooltip.classList.remove('active');
      guideHighlight.classList.remove('active');
      // íŒ¨ë„ ìƒíƒœ ë³µì›
      if(wasPanelOpenBeforeGuide===false && bottomPanelOpen){
        toggleBottomPanel(false);
      }
      showToast('success','ê°€ì´ë“œ ì¢…ë£Œ','ê°€ì´ë“œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.');
    }

    // ========= í† ìŠ¤íŠ¸/ìë™ìƒˆë¡œê³ ì¹¨/í‚¤ë³´ë“œ =========
    function showToast(type,title,msg){
      const t=document.getElementById('toast');
      t.className=`toast ${type} active`;
      toastTitle.textContent=title; toastMessage.textContent=msg;
      setTimeout(()=>t.classList.remove('active'),3000);
    }

    function startAutoRefresh(){
      if(autoRefreshInterval) clearInterval(autoRefreshInterval);
      autoRefreshInterval=setInterval(()=>{ loadGitHubData(); }, 300000);
    }

    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'&&bottomPanelOpen) toggleBottomPanel(false);
      if((e.ctrlKey||e.metaKey)&&e.key==='r'){ e.preventDefault(); loadGitHubData(); }
      if((e.ctrlKey||e.metaKey)&&e.key==='f'){ e.preventDefault(); if(!bottomPanelOpen) toggleBottomPanel(true); driverSearch.focus(); }
      if(e.key==='F1'){ e.preventDefault(); showGuide(); }
    });

    window.addEventListener('resize', ()=>{ if(map) setTimeout(()=>map.invalidateSize(),300); });
  </script>
</body>
</html>
